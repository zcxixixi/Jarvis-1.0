# AI Development Guidelines for Jarvis

> **READ THIS FIRST** before making any changes to the codebase.

## ğŸš« FROZEN FILES (Do Not Modify Without Explicit Approval)

These files are the **core engine** of Jarvis 1.0. Changes here can break critical functionality.

| File | Reason |
|------|--------|
| `hybrid_jarvis.py` | Core state machine, audio loops, WebSocket protocol. Any change requires full regression testing. |
| `protocol.py` | Doubao API binary protocol implementation. Modification will break cloud connectivity. |
| `wake_word.py` | Porcupine wake word detection. Changes may cause wake detection failures. |
| `jarvis_doubao_config.py` | Contains API credentials and persona. Only modify `system_role` for persona changes. |

**If you must modify a frozen file:**
1. Create a git branch first: `git checkout -b fix/your-fix-name`
2. Make minimal, targeted changes
3. Test thoroughly before merging
4. Update the version tag if changes are significant

---

## âœ… SAFE TO MODIFY

| Directory/File | Purpose |
|----------------|---------|
| `tools/` | Add new tools (weather, music, smart home, etc.) here. Follow existing patterns. |
| `plugins/` | (Future) Add new feature modules here. |
| `jarvis_doubao_config.py` â†’ `system_role` | Persona/character adjustments only. |
| `RASPBERRY_PI.md`, `README.md` | Documentation updates. |

---

## ğŸ“¦ Adding New Tools

When adding a new tool to `tools/`:

1. Create a new file: `tools/your_tool.py`
2. Follow the existing pattern (see `weather_tools.py` as reference)
3. Register the tool in `tools/__init__.py`
4. Add intent detection keywords in `hybrid_jarvis.py` â†’ `check_and_run_tool()` method
5. Test with both voice and keyboard input

---

## ğŸ§ª Testing Requirements

Before merging any changes:

```bash
# 1. Syntax check
python3 -m py_compile hybrid_jarvis.py

# 2. Run the system
python3 hybrid_jarvis.py

# 3. Test these flows:
#    - Wake word detection ("Jarvis")
#    - Weather query ("ä»Šå¤©åŒ—äº¬å¤©æ°”")
#    - Music playback ("æ’­æ”¾éŸ³ä¹" then "æš‚åœ")
#    - Sleep command ("é€€ä¸‹")
```

---

## ğŸ·ï¸ Version Tags

| Tag | Description |
|-----|-------------|
| `v1.0` | First stable release. Full-duplex voice, music control, continuous conversation. |

To rollback to a stable version:
```bash
git checkout v1.0
```

---

## ğŸš¨ Known Sensitive Areas

1. **Echo Suppression**: The `self_speaking_mute` flag is critical. If removed, Jarvis will hear himself and loop infinitely.

2. **Timeout Reset**: The `active_until` timer must be reset after bot speech ends. Otherwise, continuous conversation breaks.

3. **City Extraction Regex**: The weather tool uses a regex with known city names. If a city is missing, add it to the pattern.

4. **Music Stop Keywords**: The priority stop logic (`æš‚åœ`, `åœæ­¢`, etc.) must be checked before music search to prevent misinterpretation.

---

## ğŸ“ Commit Message Convention

Use emoji prefixes:
- ğŸš€ New feature
- ğŸ”§ Bug fix
- ğŸ“ Documentation
- ğŸ¨ UI/style changes
- âš¡ Performance improvement
- ğŸ”’ Security fix

Example: `ğŸ”§ Fix city extraction regex for weather tool`
